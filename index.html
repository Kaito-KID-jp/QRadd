<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>製造仕様書（兼）チェックシート ＱＲコード挿入システム</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            font-size: 14px; /* デフォルトフォントサイズ */
        }

        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0; /* Flexboxの子要素が親を超えないように */
        }

        .controls {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .preview {
            flex: 1;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* プレビューが大きい場合にスクロール */
            min-height: 0;
        }

        .preview canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* アスペクト比維持 */
        }

        .preview-message {
            color: #666;
            text-align: center;
        }

        label {
            font-weight: bold;
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        button, input[type="file"] {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .file-input-button {
            background-color: #007bff;
            color: white;
            display: inline-block;
            text-align: center;
        }

        #printButton {
            background-color: #28a745;
            color: white;
        }
        #printButton:disabled {
            background-color: #6c757d;
        }

        .file-name {
            font-style: italic;
            color: #555;
            word-break: break-all;
        }

        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            z-index: 1000;
            cursor: wait; /* 待機カーソル */
        }

        .hidden {
            display: none;
        }

        /* 非表示iframe用 */
        .print-iframe {
            position: absolute;
            width: 0;
            height: 0;
            border: 0;
            left: -9999px;
        }

        .print-instruction {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <h1>製造仕様書（兼）チェックシート ＱＲコード挿入システム</h1>

    <div class="container">
        <div class="controls">
            <div>
                <input type="file" id="pdfFile" accept=".pdf" class="hidden">
                <button type="button" class="file-input-button" onclick="document.getElementById('pdfFile').click();">📂 PDFファイルを選択</button>
                <p>選択中のファイル: <span id="fileName" class="file-name">ファイル未選択</span></p>
            </div>

            <div>
                <label for="lotNumber">⌨️ ロット番号 :</label>
                <input type="text" id="lotNumber" pattern="^[a-zA-Z0-9\-]*$" title="半角英数字とハイフンのみ入力可能です">
            </div>

            <div>
                <button type="button" id="printButton" disabled>🖨️ 印刷 (QRコード裏面)</button>
                <p id="printInstruction" class="print-instruction hidden">
                    印刷ダイアログが表示されます。<br>
                    <b>「両面印刷」</b>を選択し、<b>「短辺とじ (Flip on Short Edge / Top bind)」</b>に設定して印刷してください。
                </p>
            </div>

            <div id="errorMessage" class="error-message"></div>
        </div>

        <div class="preview" id="previewArea">
            <p class="preview-message">PDFファイルを選択してください</p>
            <canvas id="pdfPreviewCanvas"></canvas>
        </div>
    </div>

    <div id="processingOverlay" class="processing-overlay hidden">
        <p>処理中...</p>
    </div>

    <iframe id="printIframe" class="print-iframe"></iframe>

    <!-- ライブラリ読み込み (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- pdf.js の読み込み (バージョンは必要に応じて変更) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // pdf.js workerの設定 (CDNから読み込む場合)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <script>
        // --- 設定値 ---
        const QR_PHYSICAL_SIZE_MM = 15;
        const QR_ERROR_CORRECTION_LEVEL = 'H'; // 'L', 'M', 'Q', 'H'
        const PDF_POINTS_PER_MM = 72 / 25.4; // 1インチ=72ポイント, 1インチ=25.4mm
        const QR_SIZE_POINTS = QR_PHYSICAL_SIZE_MM * PDF_POINTS_PER_MM;

        // --- DOM要素 ---
        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameLabel = document.getElementById('fileName');
        const lotNumberInput = document.getElementById('lotNumber');
        const printButton = document.getElementById('printButton');
        const previewArea = document.getElementById('previewArea');
        const previewCanvas = document.getElementById('pdfPreviewCanvas');
        const previewMessage = previewArea.querySelector('.preview-message');
        const errorMessageDiv = document.getElementById('errorMessage');
        const processingOverlay = document.getElementById('processingOverlay');
        const printIframe = document.getElementById('printIframe');
        const printInstruction = document.getElementById('printInstruction');

        // --- グローバル変数 ---
        let selectedPdfFile = null;
        let originalPdfFileName = '';
        let currentObjectUrl = null;

        // --- 初期化 ---
        function initialize() {
            // ロット番号の初期値を設定 (yy-mm-dd)
            const today = new Date();
            const year = String(today.getFullYear()).slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            lotNumberInput.value = `${year}-${month}-${day}`;

            // イベントリスナー設定
            pdfFileInput.addEventListener('change', handleFileSelect);
            lotNumberInput.addEventListener('input', validateLotNumber);
            printButton.addEventListener('click', handlePrint);

            // ウィンドウリサイズ時のプレビュー再描画 (簡易版)
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (selectedPdfFile) {
                        displayPdfPreview(selectedPdfFile);
                    }
                }, 250); // 250ms待ってからリサイズ処理
            });
        }

        // --- ファイル選択処理 ---
        async function handleFileSelect(event) {
            clearError();
            hidePrintInstruction();
            const file = event.target.files[0];
            if (!file) {
                selectedPdfFile = null;
                fileNameLabel.textContent = 'ファイル未選択';
                printButton.disabled = true;
                clearPreview();
                return;
            }

            if (file.type !== 'application/pdf') {
                showError('PDFファイルを選択してください。');
                selectedPdfFile = null;
                fileNameLabel.textContent = 'ファイル未選択';
                printButton.disabled = true;
                clearPreview();
                pdfFileInput.value = ''; // 入力をクリア
                return;
            }

            selectedPdfFile = file;
            originalPdfFileName = file.name;
            fileNameLabel.textContent = originalPdfFileName;
            printButton.disabled = false;

            showProcessing('プレビューを読み込み中...');
            try {
                await displayPdfPreview(selectedPdfFile);
            } catch (error) {
                console.error('プレビュー生成エラー:', error);
                showError(`PDFプレビューの表示に失敗しました: ${error.message}`);
                clearPreview();
                printButton.disabled = true;
            } finally {
                hideProcessing();
            }
        }

        // --- PDFプレビュー表示 ---
        async function displayPdfPreview(file) {
            const fileReader = new FileReader();
            fileReader.readAsArrayBuffer(file);

            return new Promise((resolve, reject) => {
                fileReader.onload = async (event) => {
                    const pdfData = new Uint8Array(event.target.result);
                    try {
                        const loadingTask = pdfjsLib.getDocument({ data: pdfData });
                        const pdf = await loadingTask.promise;

                        if (pdf.numPages === 0) {
                           throw new Error('PDFにページがありません。');
                        }

                        const page = await pdf.getPage(1); // 最初のページを取得

                        const viewport = page.getViewport({ scale: 1.5 }); // プレビューの解像度調整
                        const canvasContext = previewCanvas.getContext('2d');

                        // Canvasサイズをプレビューエリアに合わせる (アスペクト比維持)
                        const containerWidth = previewArea.clientWidth;
                        const containerHeight = previewArea.clientHeight;
                        const scale = Math.min(containerWidth / viewport.width, containerHeight / viewport.height);
                        const scaledViewport = page.getViewport({ scale: scale * 0.95 }); // 少しマージンを持たせる

                        previewCanvas.height = scaledViewport.height;
                        previewCanvas.width = scaledViewport.width;

                        const renderContext = {
                            canvasContext: canvasContext,
                            viewport: scaledViewport
                        };
                        await page.render(renderContext).promise;

                        previewMessage.classList.add('hidden');
                        previewCanvas.classList.remove('hidden');
                        resolve();
                    } catch (error) {
                        console.error('PDFプレビュー処理エラー:', error);
                        reject(error);
                    }
                };
                fileReader.onerror = (error) => {
                    console.error('ファイル読み込みエラー:', error);
                    reject(new Error('ファイル読み込みに失敗しました。'));
                };
           });
        }

        function clearPreview() {
            const context = previewCanvas.getContext('2d');
            context.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCanvas.classList.add('hidden');
            previewMessage.textContent = 'PDFファイルを選択してください';
            previewMessage.classList.remove('hidden');
        }

        // --- ロット番号バリデーション ---
        function validateLotNumber() {
            const lotNumber = lotNumberInput.value;
            // 正規表現を修正: 空文字列も許可しない場合は '+' を使う
            const pattern = /^[a-zA-Z0-9\-]+$/; // 1文字以上の英数字ハイフン
            if (!pattern.test(lotNumber) && lotNumber !== '') { // 入力途中は許容する
                // 不正な文字が含まれていれば、それを削除する（あるいはエラー表示）
                // lotNumberInput.value = lotNumber.replace(/[^a-zA-Z0-9\-]/g, ''); // 自動削除は好ましくない場合もある
                // showError('ロット番号には半角英数字とハイフンのみ使用できます。', true); // 一時的なエラー表示
                 return false; // エラー状態を返す
            }
            // clearError(); // 正しければエラーを消す（他のエラーを消さないように注意）
            return pattern.test(lotNumberInput.value); // 最終的な値でチェック
        }

        // --- 印刷処理 ---
        // ***** ここからが修正箇所 *****
        async function handlePrint() {
            if (!selectedPdfFile) {
                showError('まずPDFファイルを選択してください。');
                return;
            }
            // ロット番号のバリデーションと取得
            const lotNumber = lotNumberInput.value;
            // 印刷ボタン押下時に最終チェック
            if (!/^[a-zA-Z0-9\-]+$/.test(lotNumber)) {
                 showError('ロット番号を正しく入力してください (半角英数字とハイフンのみ、空欄不可)。');
                 return;
            }

            showProcessing('QRコード生成とPDF加工中...');
            clearError();
            hidePrintInstruction();

            // ★★★ デバッグログの追加とエラーハンドリング強化 ★★★
            try {
                // 1. QRコードデータ生成
                const baseFileName = originalPdfFileName.replace(/\.[^/.]+$/, ""); // 拡張子除去
                const firstPartFileName = baseFileName.split(' ')[0]; // 最初のスペースまで
                const qrData = `FXQR,1,dn,1,#d#,fn,${firstPartFileName}_${lotNumber},hs,1,at,0,RQXF`;
                console.log('★デバッグログ: QR Data:', qrData); // ★デバッグログ

                // 2. QRコード画像生成 (PNG Data URLとして)
                let qrCodeDataURL;
                try {
                    qrCodeDataURL = await QRCode.toDataURL(qrData, {
                        errorCorrectionLevel: QR_ERROR_CORRECTION_LEVEL.toLowerCase(),
                        type: 'image/png',
                        margin: 1,
                        scale: 8, // 十分な解像度を持たせる
                        color: { dark:"#000000", light:"#FFFFFF" }
                    });
                    console.log('★デバッグログ: QR Code Data URL generated (first 100 chars):', qrCodeDataURL.substring(0, 100) + '...'); // ★デバッグログ
                    if (!qrCodeDataURL || !qrCodeDataURL.startsWith('data:image/png')) {
                        throw new Error('生成されたData URLが無効です。');
                    }
                } catch (qrError) {
                    console.error('QRコード生成エラー:', qrError);
                    throw new Error(`QRコード画像の生成に失敗しました: ${qrError.message}`);
                }


                // 3. 元のPDF読み込み
                const pdfBytes = await selectedPdfFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, {
                    // ignoreEncryption: true // 必要に応じて
                });
                console.log('★デバッグログ: Original PDF loaded. Pages:', pdfDoc.getPageCount()); // ★デバッグログ

                // 4. QRコード画像を埋め込み用に変換
                let qrImage;
                try {
                    const qrImageBytes = await fetch(qrCodeDataURL).then(res => {
                        if (!res.ok) throw new Error(`Failed to fetch QR code Data URL: ${res.statusText}`);
                        return res.arrayBuffer();
                    });
                    console.log('★デバッグログ: QR Image Bytes fetched, length:', qrImageBytes.byteLength); // ★デバッグログ
                    if (qrImageBytes.byteLength === 0) {
                         throw new Error('QRコード画像のバイトデータ取得に失敗しました (サイズ0)。');
                    }
                    // pdf-libのインスタンスを介して画像を埋め込む
                    qrImage = await pdfDoc.embedPng(qrImageBytes);
                    console.log('★デバッグログ: QR Image embedded into PDF:', qrImage); // ★デバッグログ (pdf-libのオブジェクトが見えるはず)
                    if (!qrImage || !qrImage.ref) { // 簡単なチェック
                         throw new Error('pdfDoc.embedPng が有効な画像を返しませんでした。');
                    }
                } catch (embedError) {
                    console.error('Error embedding QR code image:', embedError);
                    throw new Error(`QRコード画像の埋め込みに失敗しました: ${embedError.message}`);
                }

                // 5. 新しいPDFを作成し、ページとQRコードを追加
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pageIndices = pdfDoc.getPageIndices();
                console.log('★デバッグログ: Calculated QR Size (points):', QR_SIZE_POINTS); // ★デバッグログ (約42.5のはず)

                for (const pageIndex of pageIndices) {
                    console.log(`★デバッグログ: Processing page index: ${pageIndex}`); // ★デバッグログ

                    // 元のページをコピー
                    const [originalPage] = await newPdfDoc.copyPages(pdfDoc, [pageIndex]);
                    newPdfDoc.addPage(originalPage);
                    const originalPageSize = originalPage.getSize(); // サイズを取得
                    console.log(`★デバッグログ: Original page ${pageIndex + 1} (size: ${originalPageSize.width}x${originalPageSize.height}) copied.`); // ★デバッグログ

                    // QRコード用の新しいページを追加 (コピーしたページのサイズを使用)
                    const qrPage = newPdfDoc.addPage([originalPageSize.width, originalPageSize.height]);
                    console.log(`★デバッグログ: QR page added for page ${pageIndex + 1}.`); // ★デバッグログ

                    // QRコードを左下に配置
                    try {
                         // 念のため、qrImageオブジェクトが存在するか再確認
                        if (!qrImage || typeof qrImage.scale !== 'function') {
                             throw new Error('埋め込まれたQR画像オブジェクト(qrImage)が無効です。描画できません。');
                        }
                        const qrDims = qrImage.scale(QR_SIZE_POINTS / qrImage.width); // サイズ調整用メソッド
                        console.log(`★デバッグログ: Drawing QR code on page ${pageIndex + 1} at (0, 0) with size ${qrDims.width}x${qrDims.height}`); // ★デバッグログ

                        // 描画するサイズを計算
                        const drawWidth = QR_SIZE_POINTS;
                        const drawHeight = QR_SIZE_POINTS; // アスペクト比は1:1のはず

                        qrPage.drawImage(qrImage, {
                            x: 0, // 左端
                            y: 0, // 下端
                            width: drawWidth,
                            height: drawHeight,
                        });
                         console.log(`★デバッグログ: QR code drawn successfully for page ${pageIndex + 1}.`); // ★デバッグログ
                    } catch (drawError) {
                         console.error(`Error drawing QR code on page ${pageIndex + 1}:`, drawError); // ★デバッグログ
                         throw new Error(`QRコードの描画に失敗しました (ページ ${pageIndex + 1}): ${drawError.message}`);
                    }
                }

                // 6. 加工済みPDFをバイトデータとして保存
                const newPdfBytes = await newPdfDoc.save({ useObjectStreams: true });
                console.log('★デバッグログ: New PDF saved to bytes. Size:', newPdfBytes.byteLength); // ★デバッグログ

                // 7. BlobとObject URLの作成
                const pdfBlob = new Blob([newPdfBytes], { type: 'application/pdf' });

                // 以前のObject URLがあれば解放
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                }
                currentObjectUrl = URL.createObjectURL(pdfBlob);

                // 8. 非表示iframeで印刷
                let printJobPending = false; // 印刷ジョブが保留中かどうかのフラグ

                printIframe.onload = () => {
                    // src が blob URL であり、かつ印刷ジョブが保留中の場合のみ実行
                    if (printIframe.src && printIframe.src.startsWith('blob:') && printJobPending) {
                        try {
                            printJobPending = false; // 実行するのでフラグを解除
                            showPrintInstruction(); // 印刷指示を表示
                            printIframe.contentWindow.print(); // 印刷ダイアログを開く
                            hideProcessing(); // 印刷ダイアログが表示されたら処理中表示を解除
                            console.log('★デバッグログ: Print dialog should be open.'); // ★デバッグログ
                        } catch (printError) {
                            console.error('印刷コマンド実行エラー:', printError);
                            showError(`印刷の開始に失敗しました: ${printError.message}`);
                            hideProcessing();
                            if (currentObjectUrl) {
                                URL.revokeObjectURL(currentObjectUrl);
                                currentObjectUrl = null;
                            }
                        }
                    }
                };
                printIframe.onerror = (err) => {
                     console.error('iframe読み込みエラー:', err);
                     showError('印刷用PDFの読み込みに失敗しました。');
                     hideProcessing();
                     if (currentObjectUrl) {
                         URL.revokeObjectURL(currentObjectUrl);
                         currentObjectUrl = null;
                     }
                };

                // iframeにsrcを設定する直前にフラグを立てる
                printJobPending = true;
                printIframe.src = currentObjectUrl;
                console.log('★デバッグログ: Setting iframe src to:', currentObjectUrl); // ★デバッグログ

            } catch (error) {
                console.error('全体処理エラー:', error); // ★既存のエラーハンドラにもログ表示
                let message = `エラーが発生しました: ${error.message}`;
                if (error instanceof PDFLib.PDFDocumentInvalidPasswordError) { // PDFLibを参照するように修正
                    message = 'PDFファイルがパスワードで保護されているため、処理できません。';
                } else if (error.message.includes('Invalid PDF structure') || error.name === 'InvalidPDFDataError') { // エラーメッセージで判定
                    message = 'PDFファイルの形式が正しくないか、破損している可能性があります。';
                }
                showError(message);
                hideProcessing();
                if (currentObjectUrl) {
                    URL.revokeObjectURL(currentObjectUrl);
                    currentObjectUrl = null;
                }
            }
        }
        // ***** ここまでが修正箇所 *****

        // --- ユーティリティ関数 ---
        function showProcessing(message = '処理中...') {
            processingOverlay.querySelector('p').textContent = message;
            processingOverlay.classList.remove('hidden');
            document.body.style.cursor = 'wait'; // bodyにも適用
        }

        function hideProcessing() {
            processingOverlay.classList.add('hidden');
            document.body.style.cursor = 'default';
        }

        function showError(message, temporary = false) {
            errorMessageDiv.textContent = message;
            if (temporary) {
                setTimeout(clearError, 3000); // 3秒後にエラーメッセージを消す
            }
        }

        function clearError() {
            errorMessageDiv.textContent = '';
        }

        function showPrintInstruction() {
            printInstruction.classList.remove('hidden');
        }
        function hidePrintInstruction() {
            printInstruction.classList.add('hidden');
        }

        // --- ページ読み込み完了時に初期化 ---
        window.onload = initialize;

        // --- ページアンロード時にObject URLを解放 ---
        window.addEventListener('beforeunload', () => {
            if (currentObjectUrl) {
                console.log('★デバッグログ: Revoking Object URL on page unload:', currentObjectUrl);
                URL.revokeObjectURL(currentObjectUrl);
            }
        });

    </script>

</body>
</html>
